@using System.Collections.Immutable
@using MyLittleContentEngine.Services.Content.TableOfContents
@using Microsoft.AspNetCore.Components.Sections
@inherits LayoutComponentBase
@inject TableOfContentService TableOfContentService
@inject NavigationManager NavigationManager

<div class="bg-base-50 dark:bg-base-900 text-base-950 dark:text-base-100 min-h-screen dark:scheme-dark">
    <BaseHeader
        HeaderStructureClass="sticky top-0 w-full h-18 md:h-24 backdrop-blur backdrop-grayscale font-display border-b shadow-md dark:shadow-lg z-50"
        HeaderColorClass="bg-base-50/95 dark:bg-base-900/95 border-primary-500/50 dark:border-primary-700"
        TitleColorClass="text-base-700 dark:text-base-200"
        HeaderIcon="@_headerIcon"
        ExtraButtons="@mobileMenuButton"/>
    <div class="max-w-8xl mx-auto px-4">

        <div class="flex flex-col md:flex-row lg:gap-x-8 gap-x-12">
            <aside id="nav-sidebar" class="w-full lg:w-64 pt-4 flex-none lg:sticky md:top-24 lg:h-[calc(100vh-6rem)] overflow-x-hidden overflow-y-auto lg:block hidden">
                <TableOfContentsNavigation TableOfContents="@_toc"/>
            </aside>
            <main class="flex-1 w-full md:w-auto min-w-0 pt-4">
                @Body
            </main>

            <aside
                class="w-72 flex-none px-4 sticky top-24 pt-4 h-[calc(100vh-6em)] overflow-x-hidden overflow-y-auto hidden xl:block">
                <SectionOutlet SectionName="sidebar"/>
            </aside>

        </div>
    </div>
</div>

@code{
    private ImmutableList<TableOfContentEntry>? _toc;

    [Parameter] public RenderFragment? SidebarChildContent { get; set; }

    private readonly RenderFragment mobileMenuButton =
        @<button id="menu-toggle" class="lg:hidden p-1 text-base-700 dark:text-base-100 rounded-md hover:bg-primary-100 dark:hover:bg-primary-800">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>;

    private readonly RenderFragment _headerIcon = @<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-8 w-8 mr-4 text-primary-600 dark:text-primary-400" stroke="currentColor" >
                                                     <defs/>
                                                     <path fill="currentColor" d="M10.444,1.25 L11.556,1.25 C13.394,1.25 14.85,1.25 15.989,1.403 C17.161,1.561 18.11,1.893 18.859,2.641 C19.607,3.39 19.939,4.339 20.097,5.511 C20.25,6.649 20.25,8.104 20.25,9.94 L20.25,11 C20.25,11.414 19.914,11.75 19.5,11.75 C19.086,11.75 18.75,11.414 18.75,11 L18.75,10 C18.75,8.093 18.748,6.739 18.61,5.711 C18.475,4.705 18.221,4.125 17.798,3.702 C17.375,3.279 16.795,3.025 15.789,2.89 C14.761,2.752 13.407,2.75 11.5,2.75 L10.5,2.75 C8.593,2.75 7.239,2.752 6.211,2.89 C5.205,3.025 4.625,3.279 4.202,3.702 C3.779,4.125 3.525,4.705 3.39,5.711 C3.252,6.738 3.25,8.093 3.25,10 L3.25,14 C3.25,15.907 3.252,17.261 3.39,18.289 C3.525,19.295 3.779,19.875 4.202,20.298 C4.625,20.721 5.205,20.975 6.211,21.11 C7.238,21.248 8.593,21.25 10.5,21.25 C10.914,21.25 11.25,21.586 11.25,22 C11.25,22.414 10.914,22.75 10.5,22.75 L10.444,22.75 C8.606,22.75 7.15,22.75 6.011,22.597 C4.838,22.439 3.89,22.107 3.141,21.359 C2.393,20.61 2.061,19.661 1.903,18.489 C1.75,17.35 1.75,15.894 1.75,14.057 L1.75,14.056 L1.75,9.944 C1.75,8.106 1.75,6.65 1.903,5.511 C2.061,4.339 2.393,3.39 3.141,2.641 C3.89,1.893 4.839,1.561 6.011,1.403 C7.15,1.25 8.606,1.25 10.444,1.25 Z M20.19,13.432 C20.452,13.562 20.675,13.786 20.888,14 L20.944,14.056 L21,14.113 C21.214,14.325 21.438,14.548 21.568,14.81 C21.811,15.3 21.811,15.876 21.568,16.366 C21.438,16.628 21.214,16.851 21,17.063 L20.944,17.12 L16.12,21.944 L16.064,22 C15.834,22.232 15.586,22.481 15.259,22.617 C14.932,22.752 14.58,22.751 14.254,22.75 L14.254,22.75 L14.174,22.75 L13,22.75 C12.586,22.75 12.25,22.414 12.25,22 L12.25,20.827 L12.25,20.747 C12.249,20.42 12.248,20.069 12.384,19.742 C12.519,19.415 12.769,19.167 13,18.937 L13.057,18.88 L17.88,14.056 L17.937,14 C18.15,13.786 18.372,13.562 18.634,13.432 C19.124,13.189 19.7,13.189 20.19,13.432 Z M6.25,7 C6.25,6.586 6.586,6.25 7,6.25 L15,6.25 C15.414,6.25 15.75,6.586 15.75,7 C15.75,7.414 15.414,7.75 15,7.75 L7,7.75 C6.586,7.75 6.25,7.414 6.25,7 Z M6.25,12 C6.25,11.586 6.586,11.25 7,11.25 L15,11.25 C15.414,11.25 15.75,11.586 15.75,12 C15.75,12.414 15.414,12.75 15,12.75 L7,12.75 C6.586,12.75 6.25,12.414 6.25,12 Z M19.236,14.83 C19.169,14.89 19.083,14.974 18.941,15.117 L14.117,19.941 C13.965,20.093 13.88,20.179 13.821,20.248 C13.795,20.278 13.781,20.297 13.775,20.306 C13.772,20.311 13.771,20.313 13.77,20.315 L13.769,20.316 L13.769,20.317 C13.769,20.318 13.768,20.321 13.767,20.326 C13.764,20.338 13.761,20.36 13.758,20.4 C13.751,20.491 13.75,20.611 13.75,20.827 L13.75,21.25 L14.174,21.25 C14.389,21.25 14.51,21.25 14.6,21.243 C14.641,21.24 14.663,21.236 14.674,21.234 C14.676,21.233 14.677,21.233 14.679,21.233 C14.681,21.232 14.683,21.232 14.683,21.231 L14.685,21.231 L14.686,21.23 C14.687,21.23 14.69,21.228 14.694,21.225 C14.704,21.219 14.722,21.206 14.753,21.18 C14.822,21.12 14.907,21.035 15.06,20.883 L19.883,16.059 C20.026,15.917 20.111,15.832 20.17,15.764 C20.208,15.722 20.222,15.702 20.225,15.697 C20.259,15.628 20.259,15.548 20.225,15.479 C20.222,15.474 20.208,15.454 20.17,15.412 C20.111,15.344 20.026,15.259 19.883,15.117 C19.741,14.974 19.656,14.89 19.589,14.83 C19.546,14.792 19.526,14.778 19.521,14.775 C19.452,14.742 19.372,14.742 19.303,14.775 C19.298,14.778 19.278,14.792 19.236,14.83 Z"/>
                                                 </svg>;

    protected override async Task OnInitializedAsync()
    {
        // need to somehow standardize this to match what we think
        _toc = await TableOfContentService.GetNavigationTocAsync(NavigationManager.ToAbsoluteUri(NavigationManager.Uri).AbsolutePath);
        await base.OnInitializedAsync();
    }

}
